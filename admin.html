<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin — Email Agent</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { font-family: 'Inter', sans-serif; }
        body { background: #0a0a0b; background-image: radial-gradient(circle at 50% 0%, rgba(124, 58, 237, 0.08) 0%, transparent 50%); min-height: 100vh; }
        .glass-card { background: rgba(23, 23, 26, 0.6); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.06); box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.02) inset, 0 10px 30px -10px rgba(0, 0, 0, 0.5); border-radius: 24px; }
        .top-bar { background: rgba(23, 23, 26, 0.8); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255, 255, 255, 0.06); }
        .logo-container { position: relative; width: 36px; height: 36px; }
        .logo-border { position: absolute; inset: 0; border-radius: 10px; border: 2px solid transparent; background: linear-gradient(#0a0a0b, #0a0a0b) padding-box, linear-gradient(135deg, rgba(6, 182, 212, 0.5) 0%, rgba(59, 130, 246, 0.5) 50%, rgba(168, 85, 247, 0.5) 100%) border-box; }
        .logo-text { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 800; color: #fff; }
        .btn-primary { background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color: white; font-weight: 600; padding: 12px 24px; border-radius: 16px; cursor: pointer; transition: all 200ms; border: none; font-size: 14px; }
        .btn-primary:hover { box-shadow: 0 8px 20px rgba(124, 58, 237, 0.35); transform: translateY(-1px); }
        .btn-ghost-sm { background: transparent; color: #a1a1aa; font-size: 13px; font-weight: 500; padding: 8px 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: all 200ms; }
        .btn-ghost-sm:hover { background: rgba(255,255,255,0.05); color: #e4e4e7; }
        .btn-danger-sm { background: transparent; color: #f87171; font-size: 13px; font-weight: 500; padding: 8px 16px; border-radius: 12px; border: 1px solid rgba(239,68,68,0.2); cursor: pointer; transition: all 200ms; }
        .btn-danger-sm:hover { background: rgba(239,68,68,0.1); }
        .section-title { font-size: 12px; font-weight: 600; text-transform: uppercase; color: #71717a; letter-spacing: 0.05em; }
        .form-label { font-size: 13px; font-weight: 500; color: #a1a1aa; margin-bottom: 6px; display: block; }
        .form-input { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 10px 14px; color: #e4e4e7; font-size: 14px; outline: none; transition: border-color 200ms; }
        .form-input:focus { border-color: rgba(124, 58, 237, 0.5); }
        .form-input::placeholder { color: #52525b; }
        textarea.form-input { resize: vertical; min-height: 72px; }
        select.form-input { cursor: pointer; }
        select.form-input option { background: #1c1c1f; }
        .stat-pill { display: inline-flex; align-items: center; gap: 5px; font-size: 12px; font-weight: 600; padding: 3px 10px; border-radius: 20px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        /* Modal */
        #modal-overlay { background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
        .faq-item { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 14px; margin-bottom: 10px; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.97); } to { opacity: 1; transform: scale(1); } }
        .modal-enter { animation: fadeIn 200ms ease-out; }
    </style>
</head>
<body class="text-gray-100">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-card p-12 max-w-md w-full text-center">
            <div class="w-14 h-14 rounded-2xl bg-purple-500/10 border border-purple-500/20 flex items-center justify-center mx-auto mb-6">
                <svg class="w-7 h-7 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
            </div>
            <h1 class="text-2xl font-bold text-white mb-2">Admin Portal</h1>
            <p class="text-sm text-gray-500 mb-8">Email Agent management dashboard</p>
            <button onclick="signInWithGoogle()" class="btn-primary w-full flex items-center justify-center gap-3" style="padding:14px 24px;border-radius:20px;">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-screen" style="display:none;">
        <nav class="top-bar sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="logo-container"><div class="logo-border"></div><div class="logo-text">AI</div></div>
                    <span class="font-semibold">Email Agent</span>
                    <span class="text-xs font-semibold px-2 py-1 rounded-lg bg-purple-500/10 text-purple-400 border border-purple-500/20 ml-1">Admin</span>
                </div>
                <button onclick="signOut()" class="btn-ghost-sm">Sign Out</button>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-6 py-8">

            <!-- Header -->
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h1 class="text-2xl font-bold text-white mb-1">Client Overview</h1>
                    <p class="text-sm text-gray-500" id="client-count">Loading...</p>
                </div>
                <button onclick="openAddClient()" class="btn-primary flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Add Client
                </button>
            </div>

            <!-- Summary Stats -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8" id="summary-stats">
                <div class="glass-card p-5"><div class="section-title mb-2">Total Clients</div><div class="text-3xl font-bold text-white" id="stat-total-clients">—</div></div>
                <div class="glass-card p-5"><div class="section-title mb-2">Active</div><div class="text-3xl font-bold text-emerald-400" id="stat-active">—</div></div>
                <div class="glass-card p-5"><div class="section-title mb-2">Emails This Month</div><div class="text-3xl font-bold text-white" id="stat-emails">—</div></div>
                <div class="glass-card p-5"><div class="section-title mb-2">Pending Approvals</div><div class="text-3xl font-bold text-amber-400" id="stat-pending">—</div></div>
            </div>

            <!-- Client Cards -->
            <div id="clients-container" class="grid grid-cols-1 lg:grid-cols-2 gap-5"></div>
        </div>
    </div>

    <!-- Add / Edit Client Modal -->
    <div id="modal-overlay" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="glass-card w-full max-w-2xl max-h-screen overflow-y-auto modal-enter" style="border-radius:28px;">
            <div class="p-7">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-white" id="modal-title">Add Client</h2>
                    <button onclick="closeModal()" class="w-8 h-8 flex items-center justify-center rounded-xl hover:bg-white/5 text-gray-400 hover:text-white transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>

                <input type="hidden" id="edit-client-id">

                <!-- Basic Info -->
                <div class="mb-6">
                    <div class="section-title mb-4">BASIC INFO</div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="form-label">Company Name</label>
                            <input type="text" id="f-company" class="form-input" placeholder="Acme Plumbing">
                        </div>
                        <div>
                            <label class="form-label">Monitored Gmail</label>
                            <input type="email" id="f-email" class="form-input" placeholder="inbox@company.com">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="form-label">Gmail OAuth Refresh Token</label>
                        <input type="text" id="f-token" class="form-input" placeholder="Paste refresh token here">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="form-label">Monthly Email Limit</label>
                            <input type="number" id="f-limit" class="form-input" value="500">
                        </div>
                        <div>
                            <label class="form-label">Data Retention (days)</label>
                            <input type="number" id="f-retention" class="form-input" value="7">
                        </div>
                    </div>
                </div>

                <!-- Agent Config -->
                <div class="mb-6">
                    <div class="section-title mb-4">AGENT CONFIG</div>
                    <div class="mb-4">
                        <label class="form-label">Business Description</label>
                        <textarea id="f-description" class="form-input" placeholder="e.g. Acme Plumbing — a plumbing company serving London..."></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="form-label">Business Hours</label>
                            <input type="text" id="f-hours" class="form-input" placeholder="Mon–Fri 9am–5pm">
                        </div>
                        <div>
                            <label class="form-label">Tone</label>
                            <select id="f-tone" class="form-input">
                                <option value="professional">Professional</option>
                                <option value="friendly">Friendly</option>
                                <option value="formal">Formal</option>
                                <option value="casual">Casual</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- AI Instructions -->
                <div class="mb-6">
                    <div class="section-title mb-4">AI INSTRUCTIONS</div>
                    <div>
                        <label class="form-label">Custom Instructions <span class="text-gray-600 font-normal normal-case">(injected into the AI prompt for this client)</span></label>
                        <textarea id="f-ai-instructions" class="form-input" style="min-height:100px;" placeholder="e.g. Always sign off as 'The Brooklyn Team'. If the customer mentions an emergency, lead with the 24/7 emergency line. Keep a warm, friendly tone — this is a family business."></textarea>
                    </div>
                </div>

                <!-- Escalation -->
                <div class="mb-6">
                    <div class="section-title mb-4">ESCALATION</div>
                    <div class="mb-4">
                        <label class="form-label">Trigger Keywords <span class="text-gray-600 font-normal normal-case">(comma separated)</span></label>
                        <input type="text" id="f-keywords" class="form-input" placeholder="refund, complaint, cancel, urgent">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="form-label">Default Escalation Email</label>
                            <input type="email" id="f-esc-default" class="form-input" placeholder="manager@company.com">
                        </div>
                        <div>
                            <label class="form-label">Senior Contact</label>
                            <input type="email" id="f-esc-senior" class="form-input" placeholder="senior@company.com">
                        </div>
                    </div>
                </div>

                <!-- FAQs -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="section-title">FAQS</div>
                        <button onclick="addModalFaq()" class="btn-ghost-sm">+ Add FAQ</button>
                    </div>
                    <div id="modal-faqs-container"></div>
                    <p id="modal-no-faqs" class="text-sm text-gray-600 text-center py-2">No FAQs yet.</p>
                </div>

                <!-- Toggles -->
                <div class="flex flex-col gap-3 mb-7">
                    <div class="flex items-center gap-3 p-4 rounded-2xl" style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);">
                        <input type="checkbox" id="f-active" checked class="w-4 h-4 accent-purple-500">
                        <div>
                            <label for="f-active" class="text-sm font-medium text-gray-300 cursor-pointer">Active — agent will process emails for this client</label>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 p-4 rounded-2xl" style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);">
                        <input type="checkbox" id="f-approval-mode" class="w-4 h-4 accent-violet-500">
                        <div>
                            <label for="f-approval-mode" class="text-sm font-medium text-gray-300 cursor-pointer">Shadow Mode — silently collect emails and AI responses, nothing is sent or actioned</label>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <button onclick="saveClient()" class="btn-primary" id="save-btn">Save Client</button>
                    <button onclick="closeModal()" class="btn-ghost-sm">Cancel</button>
                    <span id="modal-toast" class="text-sm text-emerald-400 ml-2" style="opacity:0;transition:opacity 300ms;">Saved!</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zkquexmmbstiakfhmfvf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InprcXVleG1tYnN0aWFrZmhtZnZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNjEyMjAsImV4cCI6MjA4NjkzNzIyMH0.W5EmisLiMfQtIk93YlbtS3zsoLCtq7JQYe3zsXwHBdk';
        const ADMIN_EMAIL = 'daniel.creasey29@googlemail.com';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let modalFaqs = [];
        let clientsMap = {};

        async function signInWithGoogle() {
            await supabaseClient.auth.signInWithOAuth({
                provider: 'google',
                options: { redirectTo: window.location.href }
            });
        }

        async function signOut() {
            await supabaseClient.auth.signOut();
            window.location.reload();
        }

        window.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) return;

            if (session.user.email !== ADMIN_EMAIL) {
                await supabaseClient.auth.signOut();
                document.getElementById('login-screen').querySelector('p.text-sm').textContent = `Signed in as ${session.user.email} — please sign in with the admin account.`;
                return;
            }

            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-screen').style.display = 'block';
            await loadDashboard();
        });

        async function loadDashboard() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            const monthStart = currentMonth + '-01';

            const { data: clients } = await supabaseClient.from('clients').select('*').order('created_at', { ascending: false });
            if (!clients) return;

            // Build lookup map
            clientsMap = {};
            clients.forEach(c => clientsMap[c.id] = c);

            // Summary stats
            document.getElementById('stat-total-clients').textContent = clients.length;
            document.getElementById('stat-active').textContent = clients.filter(c => c.is_active && !c.admin_paused).length;
            document.getElementById('client-count').textContent = `${clients.length} client${clients.length !== 1 ? 's' : ''} registered`;

            // Get email counts for all clients this month
            const { count: totalEmails } = await supabaseClient.from('emails').select('*', { count: 'exact', head: true }).gte('created_at', monthStart);
            const { count: pendingCount } = await supabaseClient.from('emails').select('*', { count: 'exact', head: true }).eq('status', 'pending_approval');
            document.getElementById('stat-emails').textContent = totalEmails || 0;
            document.getElementById('stat-pending').textContent = pendingCount || 0;

            // Render client cards
            const container = document.getElementById('clients-container');
            container.innerHTML = '';

            for (const client of clients) {
                const { count: clientEmails } = await supabaseClient.from('emails').select('*', { count: 'exact', head: true }).eq('client_id', client.id).gte('created_at', monthStart);
                const { count: clientAutoReplied } = await supabaseClient.from('emails').select('*', { count: 'exact', head: true }).eq('client_id', client.id).eq('status', 'auto_replied').gte('created_at', monthStart);
                const { count: clientEscalated } = await supabaseClient.from('emails').select('*', { count: 'exact', head: true }).eq('client_id', client.id).eq('status', 'escalated').gte('created_at', monthStart);
                const { count: clientPending } = await supabaseClient.from('emails').select('*', { count: 'exact', head: true }).eq('client_id', client.id).eq('status', 'pending_approval');

                const lastCheck = client.last_check ? new Date(client.last_check).toLocaleString('en-GB', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }) : 'Never';

                const card = document.createElement('div');
                card.className = 'glass-card p-6';
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-5">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-purple-500/10 flex items-center justify-center font-bold text-purple-400 text-sm flex-shrink-0">
                                ${client.company_name.split(' ').slice(0,2).map(w => w[0]).join('').toUpperCase()}
                            </div>
                            <div>
                                <div class="font-semibold text-white">${escHtml(client.company_name)}</div>
                                <div class="text-xs text-gray-500">${escHtml(client.monitored_email)}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 flex-wrap">
                            <span class="stat-pill ${client.admin_paused ? 'bg-orange-500/10 text-orange-400' : client.is_active ? 'bg-emerald-500/10 text-emerald-400' : 'bg-red-500/10 text-red-400'}">
                                <span class="status-dot ${client.admin_paused ? 'bg-orange-400' : client.is_active ? 'bg-emerald-400' : 'bg-red-400'}"></span>
                                ${client.admin_paused ? 'Admin Paused' : client.is_active ? 'Active' : 'Paused'}
                            </span>
                            ${client.config?.approval_mode ? '<span class="stat-pill bg-violet-500/10 text-violet-400"><span class="status-dot bg-violet-400"></span>Shadow Mode</span>' : ''}
                        </div>
                    </div>

                    <div class="grid grid-cols-4 gap-3 mb-5">
                        <div class="text-center p-3 rounded-xl" style="background:rgba(255,255,255,0.03);">
                            <div class="text-xl font-bold text-white">${clientEmails || 0}</div>
                            <div class="text-xs text-gray-600 mt-0.5">Total</div>
                        </div>
                        <div class="text-center p-3 rounded-xl" style="background:rgba(255,255,255,0.03);">
                            <div class="text-xl font-bold text-emerald-400">${clientAutoReplied || 0}</div>
                            <div class="text-xs text-gray-600 mt-0.5">Auto-replied</div>
                        </div>
                        <div class="text-center p-3 rounded-xl" style="background:rgba(255,255,255,0.03);">
                            <div class="text-xl font-bold text-orange-400">${clientEscalated || 0}</div>
                            <div class="text-xs text-gray-600 mt-0.5">Escalated</div>
                        </div>
                        <div class="text-center p-3 rounded-xl" style="background:rgba(255,255,255,0.03);">
                            <div class="text-xl font-bold text-amber-400">${clientPending || 0}</div>
                            <div class="text-xs text-gray-600 mt-0.5">Pending</div>
                        </div>
                    </div>

                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-600">Last check: ${lastCheck}</span>
                        <div class="flex items-center gap-2">
                            <button onclick="toggleAdminPause('${client.id}', ${client.admin_paused})" class="btn-ghost-sm" style="${client.admin_paused ? 'color:#fb923c;border-color:rgba(249,115,22,0.3);' : ''}">${client.admin_paused ? 'Release Pause' : 'Admin Pause'}</button>
                            <button onclick="openEditClient('${client.id}')" class="btn-ghost-sm">Edit</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            }
        }

        async function toggleAdminPause(clientId, currentState) {
            await supabaseClient.from('clients').update({ admin_paused: !currentState }).eq('id', clientId);
            await loadDashboard();
        }

        // ── Modal ──────────────────────────────────────────────────────────────
        function openAddClient() {
            document.getElementById('modal-title').textContent = 'Add Client';
            document.getElementById('edit-client-id').value = '';
            document.getElementById('f-company').value = '';
            document.getElementById('f-email').value = '';
            document.getElementById('f-token').value = '';
            document.getElementById('f-limit').value = '500';
            document.getElementById('f-retention').value = '7';
            document.getElementById('f-description').value = '';
            document.getElementById('f-hours').value = '';
            document.getElementById('f-tone').value = 'professional';
            document.getElementById('f-keywords').value = '';
            document.getElementById('f-esc-default').value = '';
            document.getElementById('f-esc-senior').value = '';
            document.getElementById('f-ai-instructions').value = '';
            document.getElementById('f-active').checked = true;
            document.getElementById('f-approval-mode').checked = false;
            modalFaqs = [];
            renderModalFaqs();
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        function openEditClient(clientId) {
            const client = clientsMap[clientId];
            const config = client.config || {};
            document.getElementById('modal-title').textContent = 'Edit Client';
            document.getElementById('edit-client-id').value = client.id;
            document.getElementById('f-company').value = client.company_name || '';
            document.getElementById('f-email').value = client.monitored_email || '';
            document.getElementById('f-token').value = client.gmail_oauth_token || '';
            document.getElementById('f-limit').value = client.email_limit || 500;
            document.getElementById('f-retention').value = config.data_retention_days || 7;
            document.getElementById('f-description').value = config.business_description || '';
            document.getElementById('f-hours').value = config.business_hours || '';
            document.getElementById('f-tone').value = (config.tone || 'professional').toLowerCase();
            document.getElementById('f-keywords').value = (config.escalation_keywords || []).join(', ');
            document.getElementById('f-esc-default').value = (config.escalation_routing || {}).default || '';
            document.getElementById('f-esc-senior').value = (config.escalation_routing || {}).senior || '';
            document.getElementById('f-ai-instructions').value = config.ai_instructions || '';
            document.getElementById('f-active').checked = client.is_active;
            document.getElementById('f-approval-mode').checked = config.approval_mode || false;
            modalFaqs = JSON.parse(JSON.stringify(config.faqs || []));
            renderModalFaqs();
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
        }

        function addModalFaq() {
            modalFaqs.push({ question: '', answer: '' });
            renderModalFaqs();
        }

        function removeModalFaq(i) {
            modalFaqs.splice(i, 1);
            renderModalFaqs();
        }

        function renderModalFaqs() {
            const container = document.getElementById('modal-faqs-container');
            const noFaqs = document.getElementById('modal-no-faqs');
            container.innerHTML = '';
            noFaqs.style.display = modalFaqs.length === 0 ? 'block' : 'none';
            modalFaqs.forEach((faq, i) => {
                const div = document.createElement('div');
                div.className = 'faq-item';
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-semibold text-purple-400 uppercase">FAQ ${i+1}</span>
                        <button onclick="removeModalFaq(${i})" class="btn-danger-sm" style="padding:4px 10px;">Remove</button>
                    </div>
                    <input type="text" class="form-input mb-2" placeholder="Question" value="${escHtml(faq.question || '')}" oninput="modalFaqs[${i}].question = this.value">
                    <textarea class="form-input" placeholder="Answer" oninput="modalFaqs[${i}].answer = this.value">${escHtml(faq.answer || '')}</textarea>
                `;
                container.appendChild(div);
            });
        }

        async function saveClient() {
            const saveBtn = document.getElementById('save-btn');
            saveBtn.textContent = 'Saving...';
            saveBtn.disabled = true;

            const clientId = document.getElementById('edit-client-id').value;
            const keywords = document.getElementById('f-keywords').value.split(',').map(k => k.trim()).filter(k => k);

            const config = {
                business_description: document.getElementById('f-description').value,
                business_hours: document.getElementById('f-hours').value,
                tone: document.getElementById('f-tone').value,
                faqs: modalFaqs.filter(f => f.question || f.answer),
                escalation_keywords: keywords,
                escalation_routing: {
                    default: document.getElementById('f-esc-default').value,
                    senior: document.getElementById('f-esc-senior').value,
                },
                data_retention_days: parseInt(document.getElementById('f-retention').value) || 7,
                approval_mode: document.getElementById('f-approval-mode').checked,
                categories: ['General Inquiry', 'Billing', 'Scheduling', 'Emergency Service', 'Pricing Questions'],
                ai_instructions: document.getElementById('f-ai-instructions').value.trim() || null,
            };

            const payload = {
                company_name: document.getElementById('f-company').value,
                monitored_email: document.getElementById('f-email').value,
                gmail_oauth_token: document.getElementById('f-token').value,
                email_limit: parseInt(document.getElementById('f-limit').value) || 500,
                is_active: document.getElementById('f-active').checked,
                config,
            };

            let error;
            if (clientId) {
                ({ error } = await supabaseClient.from('clients').update(payload).eq('id', clientId));
            } else {
                payload.current_month_count = 0;
                ({ error } = await supabaseClient.from('clients').insert(payload));
            }

            saveBtn.textContent = 'Save Client';
            saveBtn.disabled = false;

            if (!error) {
                const toast = document.getElementById('modal-toast');
                toast.style.opacity = '1';
                setTimeout(() => { toast.style.opacity = '0'; }, 2000);
                setTimeout(() => { closeModal(); loadDashboard(); }, 1500);
            } else {
                alert('Save failed: ' + error.message);
            }
        }

        function escHtml(str) {
            return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }

        // Close modal on overlay click
        document.getElementById('modal-overlay').addEventListener('click', (e) => {
            if (e.target === document.getElementById('modal-overlay')) closeModal();
        });
    </script>
</body>
</html>
